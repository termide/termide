# Руководство разработчика

Это руководство для разработчиков, которые хотят внести вклад в TermIDE или понять его кодовую базу.

## Настройка окружения разработки

### Требования

- **Rust 1.70+** (стабильный toolchain)
- **Git** для контроля версий
- **Опционально:** Nix с включёнными flakes для воспроизводимых сборок

### Получение исходного кода

```bash
git clone https://github.com/termide/termide.git
cd termide
```

### Сборка

#### С помощью Cargo (стандартно)

```bash
# Сборка для разработки
cargo build

# Release-сборка с оптимизациями
cargo build --release

# Запуск в режиме разработки
cargo run

# Запуск в release-режиме
cargo run --release
```

#### С помощью Nix (воспроизводимо)

```bash
# Войти в окружение разработки со всеми зависимостями
nix develop

# Собрать с помощью Nix
nix build

# Запустить проверки
nix flake check
```

### Запуск тестов

```bash
# Запустить все тесты
cargo test

# Запустить тесты с выводом
cargo test -- --nocapture

# Запустить конкретный тест
cargo test test_name
```

### Проверка качества кода

```bash
# Проверить ошибки компиляции
cargo check

# Запустить линтер clippy
cargo clippy

# Форматировать код
cargo fmt

# Проверить форматирование без изменения файлов
cargo fmt --check
```

## Структура проекта

```
termide/
├── src/
│   ├── app/                    # Ядро приложения и обработка событий
│   │   ├── mod.rs             # Основная структура приложения
│   │   ├── key_handler.rs     # Обработка клавиатуры
│   │   ├── mouse_handler.rs   # Обработка мыши
│   │   ├── modal_handler.rs   # Обработка модальных окон
│   │   └── modal/             # Реализации модальных окон
│   ├── config.rs              # Управление конфигурацией
│   ├── constants.rs           # Константы приложения
│   ├── i18n/                  # Интернационализация
│   │   ├── en.rs             # Английские строки
│   │   └── ru.rs             # Русские строки
│   ├── layout_manager.rs      # Компоновка панелей и система аккордеона
│   ├── panels/                # Реализации панелей
│   │   ├── mod.rs            # Определение трейта Panel
│   │   ├── panel_group.rs    # Вертикальная группа-аккордеон
│   │   ├── file_manager/     # Панель файлового менеджера
│   │   ├── editor.rs         # Панель текстового редактора
│   │   ├── terminal_pty.rs   # Панель терминала с PTY
│   │   ├── debug.rs          # Панель отладочной информации
│   │   └── welcome.rs        # Панель приветствия
│   ├── state.rs               # Управление состоянием приложения
│   ├── system_monitor.rs      # Мониторинг CPU/RAM
│   ├── theme.rs               # Система тем
│   └── ui/                    # UI компоненты
│       ├── layout.rs         # Рендеринг основной компоновки
│       ├── panel_rendering.rs # Утилиты рендеринга панелей
│       ├── menu.rs           # Строка меню
│       ├── modal.rs          # Модальные диалоги
│       ├── status_bar.rs     # Статусная строка
│       └── dropdown.rs       # Выпадающие меню
├── themes/                    # Встроенные определения тем (TOML)
├── doc/                       # Документация
│   ├── en/                   # Английская документация
│   └── ru/                   # Русская документация
└── help/                      # Файлы справки в приложении
    ├── en.txt                # Английская справка
    └── ru.txt                # Русская справка
```

## Ключевые компоненты

### 1. LayoutManager (`src/layout_manager.rs`)

Управляет системой компоновки панелей-аккордеон:
- Отслеживает FileManager (статическую левую панель)
- Управляет горизонтальными группами панелей
- Обрабатывает навигацию фокуса
- Реализует умное стекирование/разделение панелей

**Ключевые типы:**
- `FocusTarget` - FileManager или Group(usize)
- `LayoutManager` - Главный координатор компоновки

### 2. PanelGroup (`src/panels/panel_group.rs`)

Представляет вертикальный стек панелей (аккордеон):
- Одна развёрнутая панель, остальные свёрнуты в заголовок
- Поддерживает expanded_index
- Обеспечивает навигацию внутри группы

### 3. Трейт Panel (`src/panels/mod.rs`)

Все панели реализуют этот трейт:
```rust
pub trait Panel {
    fn render(&mut self, area: Rect, buf: &mut Buffer, is_focused: bool, panel_index: usize, state: &AppState);
    fn handle_key(&mut self, key: KeyEvent) -> Result<()>;
    fn handle_mouse(&mut self, mouse: MouseEvent, panel_area: Rect) -> Result<()>;
    fn title(&self) -> String;
    fn is_welcome_panel(&self) -> bool { false }
    // ... другие методы
}
```

### 4. Обработка событий

**Поток:**
1. `EventHandler` опрашивает события терминала
2. События направляются в соответствующий обработчик:
   - `key_handler.rs` для клавиатуры
   - `mouse_handler.rs` для мыши
   - `modal_handler.rs` для модальных окон
3. Обработчики обновляют `LayoutManager` и состояния панелей
4. UI перерисовывается на следующем кадре

### 5. Управление состоянием (`src/state.rs`)

`AppState` содержит:
- Конфигурацию темы
- Размеры терминала
- Наблюдатель файловой системы
- Состояние пакетных операций
- Состояние модальных окон
- Сообщения об ошибках

## Соглашения по коду

### Стиль

- Следуйте стандартному стилю Rust (применяется `cargo fmt`)
- Используйте осмысленные имена переменных
- Держите функции сфокусированными и небольшими
- Добавляйте комментарии для сложной логики

### Обработка ошибок

- Используйте `anyhow::Result` для распространения ошибок
- Используйте `.context()` или `.with_context()` для добавления контекста ошибок
- Избегайте `.unwrap()` - используйте `.expect()` с описательным сообщением или правильную обработку ошибок
- Логируйте ошибки в `state.log_error()` для отладки

### UI код

- Используйте виджеты `ratatui` для рендеринга
- Держите логику рендеринга отдельно от бизнес-логики
- Тщательно рассчитывайте размеры (учитывайте границы, отступы)
- Тестируйте UI при разных размерах терминала

### Реализация панели

При создании новой панели:

1. Реализуйте трейт `Panel`
2. Обработайте ввод с клавиатуры в `handle_key()`
3. Обработайте ввод мыши в `handle_mouse()`
4. Реализуйте правильный рендеринг в `render()`
5. Верните осмысленный `title()` для заголовка панели
6. Добавьте создание панели в `app/mod.rs` или меню

## Тестирование

### Чек-лист ручного тестирования

При внесении изменений проверьте:
- [ ] Разные размеры терминала (изменение размера во время работы)
- [ ] Навигацию с клавиатуры (все горячие клавиши)
- [ ] Взаимодействия с мышью (клики, прокрутка)
- [ ] Модальные диалоги (открытие, закрытие, взаимодействие)
- [ ] Управление панелями (открытие, закрытие, стекирование, разделение)
- [ ] Переключение тем
- [ ] Как английский, так и русский UI

### Частые проблемы

**Глюки рендеринга панелей:**
- Проверьте вычисления границ
- Убедитесь, что area.width/height учитывают границы (вычесть 2)
- Тестируйте при минимальной ширине (80 символов)

**Проблемы с фокусом:**
- Проверьте, что FocusTarget обновляется корректно
- Проверьте обработку фокуса в обработчиках событий
- Тестируйте навигацию с пустыми группами

**Утечки памяти:**
- Убедитесь, что панели правильно удаляются при закрытии
- Проверьте циклические ссылки
- Мониторьте с помощью `cargo clippy`

## Рабочий процесс вклада

1. **Сделайте форк** репозитория
2. **Создайте ветку** для вашей функции/исправления
3. **Внесите изменения**, следуя соглашениям по коду
4. **Тщательно протестируйте** (см. чек-лист выше)
5. **Запустите проверки качества кода:**
   ```bash
   cargo fmt
   cargo clippy
   cargo test
   ```
6. **Сделайте коммит** с чёткими, описательными сообщениями
7. **Отправьте** в ваш форк
8. **Откройте Pull Request** с:
   - Чётким описанием изменений
   - Почему изменение необходимо
   - Результатами тестирования
   - Скриншотами для изменений UI

## Отладка

### Логирование

TermIDE записывает логи в:
- Linux: `~/.config/termide/termide.log`
- macOS: `~/Library/Application Support/termide/termide.log`
- Windows: `%APPDATA%\\termide\\termide.log`

Используйте логирование в коде:
```rust
state.log_info("Информационное сообщение");
state.log_error(format!("Ошибка: {}", error));
state.log_debug("Отладочное сообщение");
```

### Панель отладки

Откройте с помощью `Alt+D`:
- Показывает состояние приложения
- Отображает последние записи логов
- Показывает информацию о панелях
- Полезно для разработки

### Частые задачи отладки

**Панель не рендерится:**
1. Проверьте, что панель находится в группе: `layout_manager.panel_groups`
2. Убедитесь, что фокус правильный: `layout_manager.focus`
3. Проверьте, что область рендеринга не нулевая

**Ввод с клавиатуры не работает:**
1. Проверьте, не открыто ли модальное окно (захватывает ввод)
2. Убедитесь, что панель имеет фокус
3. Проверьте трансляцию клавиш (поддержка кириллицы)

**Использование памяти растёт:**
1. Запустите с `valgrind` или аналогом
2. Проверьте неограниченные коллекции
3. Убедитесь, что панели удаляются при закрытии

## Соображения производительности

### Рендеринг

- Минимизируйте дорогие операции в `render()`
- Кешируйте вычисленные значения, когда возможно
- Используйте размеры `area` для ограничения работы
- Профилируйте с помощью `cargo flamegraph` при необходимости

### Файловые операции

- Используйте асинхронные операции, где уместно
- Реализуйте дебаунсинг для событий файловой системы
- Ограничивайте глубину обхода директорий
- Обрабатывайте большие файлы изящно (лимит 100 МБ)

### Операции терминала

- Группируйте записи в терминал
- Минимизируйте перерисовки экрана
- Используйте частичные обновления, когда возможно

## Ресурсы

- **Ratatui:** https://github.com/ratatui-org/ratatui
- **Crossterm:** https://github.com/crossterm-rs/crossterm
- **Tree-sitter:** https://tree-sitter.github.io/
- **Rust Book:** https://doc.rust-lang.org/book/

## Получение помощи

- **Проблемы:** https://github.com/termide/termide/issues
- **Обсуждения:** Используйте GitHub Discussions для вопросов
- **Ревью кода:** Запросите ревью для вашего PR

## Лицензия

TermIDE распространяется под лицензией MIT. Внося вклад, вы соглашаетесь лицензировать ваш вклад на тех же условиях.
